---

# if ansible facts contain a btrfs filssystem, ensure scrub enabled and start it
- name: check if the btrfs filesystem is being used
  set_fact:
    btrfs_exists: true
  loop: "{{ansible_mounts}}"
  when: "'btrfs' in item.fstype"

- name: enable and/or start btrfs-scrub@-.timer
  systemd: enabled=yes state=started daemon_reload=yes name=btrfs-scrub@-.timer
  when: btrfs_exists

- name: push updatedb config
  copy:
    src: etc/updatedb.conf
    dest: /etc/updatedb.conf
    directory_mode: no
    owner: root
    group: root
    mode: '0644'
    backup: yes
  when: btrfs_exists

- name: install snapper stuff
  aur:
    use: pacaur
    name: "{{ snapper_pkgs }}"
    state: present
  become: True
  become_user: "{{ unix_admin.name }}"
  tags: ['packages']
  when: btrfs_exists

- name: push snapper configs
  template: >
    src=etc/snapper/configs/config.j2
    dest=/etc/snapper/configs/{{ item.name }}
    mode=0644
    owner=0
    group=0
    backup=yes
  loop: "{{ subvolumes }}"
  when: btrfs_exists
